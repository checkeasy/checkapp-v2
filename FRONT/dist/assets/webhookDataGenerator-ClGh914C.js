function w(e){if(!e||e.trim()==="")return{url:"",base64:""};const t=e.trim();return t.startsWith("http://")||t.startsWith("https://")?{url:t,base64:""}:t.startsWith("data:image")?{url:"",base64:t}:(console.warn("âš ï¸ Valeur photo non reconnue (ni URL ni base64):",t.substring(0,50)),{url:"",base64:""})}async function F(e,t){var p,m,d,g,I,h,b;if(console.log("ðŸš€ GÃ©nÃ©ration webhook UNIFIÃ‰ - Structure optimisÃ©e et lisible"),!e)throw new Error("sessionData est requis pour gÃ©nÃ©rer le webhook");const o=N(e),n=k(e),l=await R(e,"unified");console.log("ðŸ“¦ TOUTES les piÃ¨ces extraites:",l.length,"piÃ¨ces"),console.log("ðŸ” DEBUG: Analyse des flowTypes dans allPieces:"),l.forEach((u,y)=>{console.log(`  PiÃ¨ce ${y} (${u.nom}): ${u.etapes.length} Ã©tapes`);const f={};u.etapes.forEach(x=>{const E=x.etape_type||"undefined";f[E]=(f[E]||0)+1}),console.log("    FlowTypes:",f)});const a=l.filter(u=>u.etapes.length>0);console.log("ðŸ“¥ TOUTES les piÃ¨ces dans CHECKIN:",a.length,"piÃ¨ces,",a.reduce((u,y)=>u+y.etapes.length,0),"Ã©tapes");const r=C(a),s=P(e),i=await U(e),c=a.some(u=>u.etapes&&u.etapes.length>0);return console.log("ðŸŽ¯ DonnÃ©es disponibles:",{hasCheckinData:c,checkinPieces:a.length,checkinEtapes:a.reduce((u,y)=>{var f;return u+(((f=y.etapes)==null?void 0:f.length)||0)},0),exitQuestions:i.length,signalements:s.length}),{webhook_version:"2.0",schema:"unified_all_in_checkin",checkID:t,parcours_id:n.parcours_id||null,logement_id:n.logement_id||null,logement_name:n.logement_name||null,agent:{id:((p=o.user_info)==null?void 0:p.phone)||null,firstname:((m=o.user_info)==null?void 0:m.firstName)||null,lastname:((d=o.user_info)==null?void 0:d.lastName)||null,phone:((g=o.user_info)==null?void 0:g.phone)||null,phoneIndex:((I=o.user_info)==null?void 0:I.phoneIndex)||null,type:((h=o.user_info)==null?void 0:h.type)||"CLIENT",type_label:((b=o.user_info)==null?void 0:b.type)==="CLIENT"?"Voyageur":"Agent",verification_status:o.verification_status||null},parcours:{id:n.parcours_id||null,name:n.parcours_name||null,type:"ðŸ  ContrÃ´le logement",start_time:e.startTime||new Date().toISOString(),current_time:new Date().toISOString(),duration_minutes:0,completion_percentage:Math.round(r.completion_rate||0),total_pieces:a.length,completed_pieces:0,pieces_with_issues:s.length},checkin:c?{pieces:a.map(u=>O(u,"unified")),stats:r,timestamp:e.checkinTimestamp||e.startTime||new Date().toISOString()}:null,checkout:null,signalements:s,exit_questions:i,taches:{},progression:{},stats:{total_pieces:a.length,total_photos:r.total_photos,total_signalements:s.length,total_exit_questions:i.length,completion_rate:Math.round(r.completion_rate||0)}}}function C(e){let t=0,o=0,n=0;return e.forEach(l=>{l.etapes.forEach(a=>{o++,(a.status==="completed"||a.status==="validated")&&n++,a.type==="photo_taken"&&t++})}),{total_pieces:e.length,total_photos:t,total_tasks:o,completed_tasks:n,completion_rate:o>0?Math.round(n/o*100):0}}function O(e,t){return{piece_id:e.id,nom:e.nom,status:e.etat_utilisateur||"non_defini",etapes:e.etapes.map(o=>{let n="",l="";if(o.type==="photo_taken"){const a=o.photo_url||o.photo_base64||"",r=w(a);n=r.url,l=r.base64}return{etape_id:o.etape_id,type:o.type,etape_type:o.etape_type||t,status:o.status,timestamp:o.timestamp,is_todo:o.is_todo||!1,todo_title:o.todo_title||"",...o.type==="photo_taken"&&{photo_id:o.photo_id,photo_url:n,photo_base64:l,validated:o.validated,retake_count:o.retake_count||0},...o.type==="button_click"&&{action:o.action_type,comment:o.comment||"",photos_attached:o.photos_attached||[]},...o.type==="signalement"&&{comment:o.comment||"",severity:o.severity||"normal",photos:o.photos||[]}}})}}function N(e){console.log("ðŸ‘¤ Extraction des donnÃ©es utilisateur depuis:",e);const t={user_info:null,connexion_info:null,verification_status:"non_verifie"};return e?(e.userInfo&&(t.user_info={phone:e.userInfo.phone||null,phoneIndex:e.userInfo.phoneIndex||null,firstName:e.userInfo.firstName||null,lastName:e.userInfo.lastName||null,type:e.userInfo.type||"CLIENT"},t.verification_status="verifie_session",console.log("âœ… DonnÃ©es utilisateur trouvÃ©es dans sessionData.userInfo")),t):(console.warn("âš ï¸ sessionData undefined"),t)}function k(e){console.log("ðŸ  Extraction parcours/logement depuis:",e);const t={parcours_id:null,parcours_name:null,logement_id:null,logement_name:null,extraction_source:"non_trouve"};if(!e)return console.warn("âš ï¸ sessionData est undefined, retour de donnÃ©es par dÃ©faut"),t;e.parcoursInfo&&(console.log("âœ… parcoursInfo trouvÃ© dans sessionData:",e.parcoursInfo),t.parcours_id=e.parcoursInfo.id||e.parcoursId||null,t.parcours_name=e.parcoursInfo.name||null,t.logement_id=e.parcoursInfo.logement_id||e.logement_id||null,t.logement_name=e.parcoursInfo.logement||null,t.extraction_source="session_parcoursInfo"),!t.parcours_id&&e.parcoursId&&(t.parcours_id=e.parcoursId,t.extraction_source="session_direct"),!t.logement_id&&e.logement_id&&(t.logement_id=e.logement_id,t.extraction_source.includes("session")||(t.extraction_source="session_direct"));try{const n=new URLSearchParams(window.location.search).get("parcours");!t.parcours_id&&n&&(t.parcours_id=n,t.extraction_source="url_params",console.log("ðŸ”— Parcours ID rÃ©cupÃ©rÃ© depuis URL:",n))}catch(o){console.warn("âš ï¸ Erreur lecture URL params:",o)}try{const o=localStorage.getItem("current-parcours");if(!t.parcours_id&&o){const n=JSON.parse(o);n.id&&(t.parcours_id=n.id,t.parcours_name=n.name||n.parcoursName||null,t.logement_name=n.logement||n.logementName||null,t.extraction_source="global_parcours",console.log("ðŸŒ DonnÃ©es parcours depuis global storage:",n))}}catch(o){console.warn("âš ï¸ Erreur lecture global parcours:",o)}try{Object.keys(localStorage).forEach(o=>{if((o.includes("parcours")||o.includes("logement"))&&!t.parcours_id)try{const n=JSON.parse(localStorage.getItem(o)||"{}");n.id&&!t.parcours_id&&(t.parcours_id=n.id,t.parcours_name=n.name||n.parcoursName||null,t.logement_name=n.logement||n.logementName||null,t.extraction_source=`localStorage_${o}`,console.log(`ðŸ”‘ DonnÃ©es rÃ©cupÃ©rÃ©es depuis ${o}:`,n))}catch{}})}catch(o){console.warn("âš ï¸ Erreur recherche localStorage:",o)}return console.log("ðŸ“Š RÃ©sultat extraction parcours/logement:",t),t}function P(e){var o,n;const t=[];return(n=(o=e==null?void 0:e.progress)==null?void 0:o.interactions)!=null&&n.signalements&&Object.entries(e.progress.interactions.signalements).forEach(([l,a])=>{const r=a.photoUrl||a.photoBase64||"",s=w(r);t.push({id:l,description:a.description||"Signalement",comment:a.comment||"",photo_url:s.url,photo_base64:s.base64,timestamp:a.timestamp||new Date().toISOString()})}),t}async function U(e){var o;console.log("ðŸŽ¯ Extraction des questions de sortie");const t=[];if((o=e==null?void 0:e.progress)!=null&&o.interactions&&"exitQuestions"in e.progress.interactions){const n=e.progress.interactions.exitQuestions;console.log("ðŸ“‹ RÃ©ponses trouvÃ©es:",Object.keys(n).length),Object.entries(n).forEach(([l,a])=>{t.push({question_id:a.questionID||l,question_content:a.questionContent||"",question_type:a.questionType||"text",checked:a.checked!==void 0?a.checked:null,text_response:a.textResponse||null,has_image:a.hasImage||!1,image_base64:a.imageBase64||null,image_url:a.imageUrl||null,image_photo_id:a.imagePhotoId||null,timestamp:a.timestamp||new Date().toISOString(),updated_at:a.updatedAt||null})})}return console.log(`âœ… Total questions de sortie extraites: ${t.length}`),t}async function R(e,t){const o=[];if(!e)return console.warn("âš ï¸ Pas de sessionData, retour de piÃ¨ces vides"),o;console.log("ðŸ” EXTRACTION VRAIES DONNÃ‰ES - sessionData:",e);const n=q(e);if(console.log("ðŸ  Ã‰tats des piÃ¨ces extraits depuis session:",n),Object.keys(n).length>0)for(const[l,a]of Object.entries(n)){const r={id:l,nom:a.nom||v(l),etat_utilisateur:a.etat_utilisateur||"non_defini",statut_validation:j(a.etat_utilisateur),etapes:$(e,l,t),signalements:[]};o.push(r)}else console.warn("âš ï¸ Aucune interaction trouvÃ©e, utilisation des piÃ¨ces par dÃ©faut avec donnÃ©es rÃ©elles"),[{id:S(),nom:"Chambre"},{id:S(),nom:"Cuisine"},{id:S(),nom:"Salle de Bain & Toilettes"},{id:S(),nom:"Salon"}].forEach(a=>{const r={id:a.id,nom:a.nom,etat_utilisateur:"non_defini",statut_validation:"en_attente",etapes:$(e,a.id,t),signalements:[]};o.push(r)});return console.log(`âœ… ${o.length} piÃ¨ces extraites depuis donnÃ©es rÃ©elles`),o}function S(){return`${Date.now()}x${Math.random().toString().substr(2,15)}`}function q(e){var o;const t={};return(o=e==null?void 0:e.progress)!=null&&o.interactions&&e.progress.interactions.buttonClicks&&Object.entries(e.progress.interactions.buttonClicks).forEach(([n,l])=>{var a;if(Array.isArray(l)&&l.length>0){const r=l[0];r.pieceId&&(t[r.pieceId]||(t[r.pieceId]={nom:((a=r.metadata)==null?void 0:a.roomName)||v(r.pieceId),etat_utilisateur:r.actionType||"non_defini"}))}}),t}function $(e,t,o){var l;console.log(`ðŸ” Extraction Ã©tapes enrichies pour piece ${t} (type=${o})`);const n=[];return(l=e==null?void 0:e.progress)!=null&&l.interactions&&(e.progress.interactions.buttonClicks&&Object.entries(e.progress.interactions.buttonClicks).forEach(([a,r])=>{(a.includes(t)||Array.isArray(r)&&r.some(i=>i.pieceId===t))&&Array.isArray(r)&&r.forEach(i=>{var g,I,h,b,u,y,f,x;const c=((g=i.metadata)==null?void 0:g.flowType)||i.flowType||((I=i.metadata)==null?void 0:I.page)||"checkin";if(i.pieceId&&i.pieceId!==t)return;let _=null;if((h=i.metadata)!=null&&h.etapeId&&/^\d+x\d+$/.test(i.metadata.etapeId))_=i.metadata.etapeId;else if(i.etapeId&&/^\d+x\d+$/.test(i.etapeId))_=i.etapeId;else if(i.buttonId&&/^\d+x\d+$/.test(i.buttonId))_=i.buttonId;else if(i.taskId){if(/^\d+x\d+$/.test(i.taskId))_=i.taskId;else if(i.taskId.includes("_")){const E=i.taskId.split("_"),T=E[E.length-1];/^\d+x\d+$/.test(T)&&(_=T)}}const p=_;console.log("ðŸ” Extraction etapeId pour button click:",{buttonId:i.buttonId,taskId:i.taskId,"click.etapeId":i.etapeId,"metadata.etapeId":(b=i.metadata)==null?void 0:b.etapeId,extractedEtapeId:p});const m=A(e,p),d={etape_id:p,status:"completed",type:"button_click",etape_type:c,action_type:i.actionType||"validate",timestamp:i.timestamp||new Date().toISOString(),is_todo:(m==null?void 0:m.is_todo)||((u=i.metadata)==null?void 0:u.isTodo)||!1,todo_title:(m==null?void 0:m.todo_title)||"",comment:((y=i.metadata)==null?void 0:y.comment)||"",photos_attached:((f=i.metadata)==null?void 0:f.photoUrls)||[],photos_count:((x=i.metadata)==null?void 0:x.photosCount)||0};n.push(d)})}),e.progress.interactions.photosTaken&&Object.entries(e.progress.interactions.photosTaken).forEach(([a,r])=>{r&&Array.isArray(r)&&r.forEach(s=>{var g,I,h,b,u,y;if(s.pieceId!==t)return;const i=((g=s.metadata)==null?void 0:g.flowType)||s.flowType||((I=s.metadata)==null?void 0:I.page)||"checkout";let c=null;if((h=s.metadata)!=null&&h.etapeId&&/^\d+x\d+$/.test(s.metadata.etapeId)&&(c=s.metadata.etapeId),!c&&s.taskId&&s.taskId.includes("_")){const f=s.taskId.split("_"),x=f[f.length-1];/^\d+x\d+$/.test(x)&&(c=x)}!c&&s.etapeId&&/^\d+x\d+$/.test(s.etapeId)&&(c=s.etapeId),c||(c=((b=s.metadata)==null?void 0:b.photoId)||s.photoId||`photo-${s.photoId}`),console.log("ðŸ” Extraction etapeId pour photo:",{photoId:s.photoId,taskId:s.taskId,"metadata.etapeId":(u=s.metadata)==null?void 0:u.etapeId,"photo.etapeId":s.etapeId,extractedEtapeId:c});const _=s.photoData||((y=s.metadata)==null?void 0:y.url)||s.uploadedUrl||"",p=w(_),m={photo_id:s.photoId,url:p.url,timestamp:s.timestamp,validated:s.validated||!1,retake_count:s.retakeCount||0},d={etape_id:c||`photo-${s.photoId}`,type:"photo_taken",etape_type:i,status:"completed",timestamp:s.timestamp||new Date().toISOString(),is_todo:!1,todo_title:"",action:"photo_taken",comment:"",photo_id:s.photoId,photo_base64:p.base64,photo_url:p.url,validated:s.validated||!1,retake_count:s.retakeCount||0,photos_attached:[m],photos_count:1};n.push(d)})}),e.progress.interactions.checkboxStates&&Object.entries(e.progress.interactions.checkboxStates).forEach(([a,r])=>{var i,c,_,p;if(console.log(`ðŸ” Traitement checkbox: ${a}`,r),(r.pieceId||a.split("_")[0])===t||a.includes(t)){const m=((i=r.metadata)==null?void 0:i.flowType)||r.flowType||((c=r.metadata)==null?void 0:c.page)||"checkout";let d=null;if((_=r.metadata)!=null&&_.etapeId&&/^\d+x\d+$/.test(r.metadata.etapeId)&&(d=r.metadata.etapeId),!d&&r.etapeId&&/^\d+x\d+$/.test(r.etapeId)&&(d=r.etapeId),!d&&r.taskId&&r.taskId.includes("_")){const I=r.taskId.split("_"),h=I[I.length-1];/^\d+x\d+$/.test(h)&&(d=h)}d||(d=r.taskId||a),console.log("ðŸ” Extraction etapeId pour checkbox:",{checkboxKey:a,taskId:r.taskId,"metadata.etapeId":(p=r.metadata)==null?void 0:p.etapeId,"checkboxData.etapeId":r.etapeId,extractedEtapeId:d});const g={etape_id:d||`checkbox-${a}`,type:"button_click",etape_type:m,status:r.isChecked||r.checked?"completed":"pending",timestamp:r.checkedAt||r.timestamp||new Date().toISOString(),is_todo:!1,todo_title:"",action:"complete",comment:"",photos_attached:[]};console.log("âœ… Checkbox transformÃ©e en button_click:",g),n.push(g)}}),console.log(`âœ… ${n.length} Ã©tapes extraites pour piÃ¨ce ${t}`)),n}function v(e){const t={chambre:"Chambre",cuisine:"Cuisine",salon:"Salon",salle_de_bain:"Salle de Bain & Toilettes"};for(const[o,n]of Object.entries(t))if(e.toLowerCase().includes(o))return n;return`PiÃ¨ce ${e.substring(0,8)}`}function j(e){switch(e){case"correct":return"validÃ©";case"deplorable":case"probleme":return"problÃ¨me_dÃ©tectÃ©";default:return"en_attente"}}function A(e,t){var o;if(!t||!((o=e==null?void 0:e.parcoursData)!=null&&o.piece))return null;for(const n of e.parcoursData.piece)if(n.etapes){const l=n.etapes.find(a=>a.etapeID===t);if(l)return{is_todo:l.isTodo||!1,todo_title:l.todoTitle||"",todo_order:l.todoOrder||"",image_url:l.image||"",piece_name:n.nom||""}}return null}export{F as generateUnifiedWebhookData};
