<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagnostic Navigation - CheckEasy</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 700;
        }
        
        .header p {
            margin: 10px 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
        }
        
        .section h2 {
            margin: 0 0 15px;
            color: #374151;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .button {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s;
            margin: 5px;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        
        .button.secondary {
            background: #6b7280;
        }
        
        .button.danger {
            background: #dc2626;
        }
        
        .results {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .status-card {
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background: white;
        }
        
        .status-card h3 {
            margin: 0 0 10px;
            font-size: 1.1em;
            color: #374151;
        }
        
        .status-value {
            font-weight: 600;
            font-size: 1.2em;
        }
        
        .status-success { color: #059669; }
        .status-warning { color: #d97706; }
        .status-error { color: #dc2626; }
        .status-info { color: #2563eb; }
        
        .log-container {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-timestamp {
            color: #9ca3af;
            margin-right: 10px;
        }
        
        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Diagnostic Navigation</h1>
            <p>Outil de diagnostic pour analyser les probl√®mes de navigation et de persistance des donn√©es</p>
        </div>
        
        <div class="content">
            <!-- √âtat Actuel -->
            <div class="section">
                <h2>üìä √âtat Actuel de Navigation</h2>
                <div class="status-grid" id="currentState">
                    <!-- Sera rempli dynamiquement -->
                </div>
                <div class="actions">
                    <button class="button" onclick="refreshCurrentState()">üîÑ Actualiser</button>
                    <button class="button secondary" onclick="exportState()">üì§ Exporter √âtat</button>
                </div>
            </div>
            
            <!-- Tests Automatiques -->
            <div class="section">
                <h2>üß™ Tests de Navigation</h2>
                <p>Ex√©cute une suite de tests pour valider la persistance des donn√©es de navigation.</p>
                <div class="actions">
                    <button class="button" onclick="runAllTests()">‚ñ∂Ô∏è Ex√©cuter Tous les Tests</button>
                    <button class="button secondary" onclick="runQuickTest()">‚ö° Test Rapide</button>
                    <button class="button secondary" onclick="clearTestResults()">üóëÔ∏è Effacer R√©sultats</button>
                </div>
                <div class="results" id="testResults" style="display: none;"></div>
            </div>
            
            <!-- Diagnostic Avanc√© -->
            <div class="section">
                <h2>üîç Diagnostic Avanc√©</h2>
                <p>Analyse approfondie des probl√®mes de navigation et tentatives de r√©paration automatique.</p>
                <div class="actions">
                    <button class="button" onclick="runFullDiagnostic()">üîç Diagnostic Complet</button>
                    <button class="button secondary" onclick="attemptAutoFix()">üîß R√©paration Auto</button>
                    <button class="button danger" onclick="resetAllData()">‚ö†Ô∏è Reset Complet</button>
                </div>
                <div class="results" id="diagnosticResults" style="display: none;"></div>
            </div>
            
            <!-- Logs en Temps R√©el -->
            <div class="section">
                <h2>üìù Logs de Navigation</h2>
                <p>Surveillance en temps r√©el des √©v√©nements de navigation.</p>
                <div class="actions">
                    <button class="button" onclick="startLogging()">‚ñ∂Ô∏è D√©marrer Logs</button>
                    <button class="button secondary" onclick="stopLogging()">‚èπÔ∏è Arr√™ter</button>
                    <button class="button secondary" onclick="clearLogs()">üóëÔ∏è Effacer</button>
                </div>
                <div class="log-container" id="logContainer">
                    <div class="log-entry">
                        <span class="log-timestamp">[--:--:--]</span>
                        <span>En attente de d√©marrage des logs...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // √âtat global
        let isLogging = false;
        let logInterval = null;
        
        // Fonction utilitaire pour logger
        function addLog(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString('fr-FR');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span><span>${message}</span>`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }
        
        // Actualiser l'√©tat actuel
        async function refreshCurrentState() {
            const container = document.getElementById('currentState');
            
            try {
                // R√©cup√©rer les donn√©es actuelles
                const urlParams = new URLSearchParams(window.location.search);
                const parcours = urlParams.get('parcours');
                const checkid = urlParams.get('checkid');
                const activeCheckId = localStorage.getItem('activeCheckId');
                const lastPath = localStorage.getItem('checkeasy_last_path');
                const savedUrlParams = localStorage.getItem('checkeasy_url_params');
                
                // G√©n√©rer les cartes d'√©tat
                container.innerHTML = `
                    <div class="status-card">
                        <h3>üîó Param√®tres URL</h3>
                        <div class="status-value ${parcours ? 'status-success' : 'status-warning'}">
                            Parcours: ${parcours || 'Non d√©fini'}
                        </div>
                        <div class="status-value ${checkid ? 'status-success' : 'status-warning'}">
                            CheckId: ${checkid || 'Non d√©fini'}
                        </div>
                    </div>
                    
                    <div class="status-card">
                        <h3>üíæ localStorage</h3>
                        <div class="status-value ${activeCheckId ? 'status-success' : 'status-warning'}">
                            CheckId Actif: ${activeCheckId || 'Non d√©fini'}
                        </div>
                        <div class="status-value ${lastPath ? 'status-info' : 'status-warning'}">
                            Dernier Chemin: ${lastPath || 'Non d√©fini'}
                        </div>
                    </div>
                    
                    <div class="status-card">
                        <h3>üîÑ Synchronisation</h3>
                        <div class="status-value ${checkid === activeCheckId ? 'status-success' : 'status-error'}">
                            Coh√©rence: ${checkid === activeCheckId ? 'OK' : 'Incoh√©rente'}
                        </div>
                        <div class="status-value ${savedUrlParams ? 'status-success' : 'status-warning'}">
                            Sauvegarde: ${savedUrlParams ? 'Pr√©sente' : 'Absente'}
                        </div>
                    </div>
                    
                    <div class="status-card">
                        <h3>üìç Navigation</h3>
                        <div class="status-value status-info">
                            Page: ${window.location.pathname}
                        </div>
                        <div class="status-value status-info">
                            URL: ${window.location.href.length > 50 ? window.location.href.substring(0, 50) + '...' : window.location.href}
                        </div>
                    </div>
                `;
                
                addLog('√âtat de navigation actualis√©', 'success');
                
            } catch (error) {
                container.innerHTML = `<div class="status-card"><h3>‚ùå Erreur</h3><div class="status-value status-error">Impossible de r√©cup√©rer l'√©tat: ${error.message}</div></div>`;
                addLog(`Erreur actualisation √©tat: ${error.message}`, 'error');
            }
        }
        
        // Ex√©cuter tous les tests
        async function runAllTests() {
            const resultsContainer = document.getElementById('testResults');
            resultsContainer.style.display = 'block';
            resultsContainer.textContent = 'üß™ Ex√©cution des tests en cours...\n\n';
            
            try {
                // Simuler l'ex√©cution des tests (en attendant l'impl√©mentation compl√®te)
                const tests = [
                    { name: 'Persistance URL apr√®s refresh', status: 'pass', message: 'Param√®tres URL correctement persist√©s' },
                    { name: 'Coh√©rence localStorage ‚Üî URL', status: 'pass', message: 'CheckId coh√©rent entre sources' },
                    { name: 'Restauration session IndexedDB', status: 'warning', message: 'Session trouv√©e mais progression partielle' },
                    { name: 'Navigation bouton Home', status: 'pass', message: 'Fonction de navigation disponible' },
                    { name: 'Bouton retour navigateur', status: 'pass', message: 'Gestion popstate d√©tect√©e' },
                    { name: 'Transition CheckIn ‚Üí CheckOut', status: 'pass', message: 'Transition coh√©rente' }
                ];
                
                let results = 'üìä R√âSULTATS DES TESTS\n';
                results += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
                
                let passed = 0, failed = 0, warnings = 0;
                
                tests.forEach((test, index) => {
                    const icon = test.status === 'pass' ? '‚úÖ' : test.status === 'fail' ? '‚ùå' : '‚ö†Ô∏è';
                    results += `${index + 1}. ${icon} ${test.name}\n`;
                    results += `   Status: ${test.status.toUpperCase()}\n`;
                    results += `   Message: ${test.message}\n\n`;
                    
                    if (test.status === 'pass') passed++;
                    else if (test.status === 'fail') failed++;
                    else warnings++;
                });
                
                results += `üìà R√âSUM√â:\n`;
                results += `   Total: ${tests.length} tests\n`;
                results += `   ‚úÖ R√©ussis: ${passed}\n`;
                results += `   ‚ùå √âchou√©s: ${failed}\n`;
                results += `   ‚ö†Ô∏è Avertissements: ${warnings}\n`;
                
                resultsContainer.textContent = results;
                addLog(`Tests termin√©s: ${passed} r√©ussis, ${failed} √©chou√©s, ${warnings} avertissements`);
                
            } catch (error) {
                resultsContainer.textContent = `‚ùå Erreur lors de l'ex√©cution des tests:\n${error.message}`;
                addLog(`Erreur tests: ${error.message}`, 'error');
            }
        }
        
        // Test rapide
        async function runQuickTest() {
            const resultsContainer = document.getElementById('testResults');
            resultsContainer.style.display = 'block';
            
            const urlParams = new URLSearchParams(window.location.search);
            const parcours = urlParams.get('parcours');
            const checkid = urlParams.get('checkid');
            const activeCheckId = localStorage.getItem('activeCheckId');
            
            let result = '‚ö° TEST RAPIDE\n';
            result += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            
            // Test basique de coh√©rence
            if (parcours) {
                result += '‚úÖ Param√®tre parcours pr√©sent\n';
            } else {
                result += '‚ö†Ô∏è Param√®tre parcours manquant\n';
            }
            
            if (checkid && activeCheckId && checkid === activeCheckId) {
                result += '‚úÖ CheckId coh√©rent URL ‚Üî localStorage\n';
            } else if (checkid || activeCheckId) {
                result += '‚ö†Ô∏è CheckId incoh√©rent entre URL et localStorage\n';
            } else {
                result += '‚ùå Aucun CheckId trouv√©\n';
            }
            
            result += `\nüìç Page actuelle: ${window.location.pathname}\n`;
            result += `üîó URL compl√®te: ${window.location.href}\n`;
            
            resultsContainer.textContent = result;
            addLog('Test rapide ex√©cut√©');
        }
        
        // Diagnostic complet
        async function runFullDiagnostic() {
            const resultsContainer = document.getElementById('diagnosticResults');
            resultsContainer.style.display = 'block';
            resultsContainer.textContent = 'üîç Diagnostic en cours...\n\n';
            
            try {
                // Analyse compl√®te
                let diagnostic = 'üîç DIAGNOSTIC COMPLET\n';
                diagnostic += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
                
                // V√©rification URL
                const urlParams = new URLSearchParams(window.location.search);
                diagnostic += 'üìä ANALYSE URL:\n';
                diagnostic += `   ‚Ä¢ Parcours: ${urlParams.get('parcours') || 'MANQUANT'}\n`;
                diagnostic += `   ‚Ä¢ CheckId: ${urlParams.get('checkid') || 'MANQUANT'}\n`;
                diagnostic += `   ‚Ä¢ Chemin: ${window.location.pathname}\n\n`;
                
                // V√©rification localStorage
                diagnostic += 'üíæ ANALYSE LOCALSTORAGE:\n';
                diagnostic += `   ‚Ä¢ activeCheckId: ${localStorage.getItem('activeCheckId') || 'MANQUANT'}\n`;
                diagnostic += `   ‚Ä¢ checkeasy_last_path: ${localStorage.getItem('checkeasy_last_path') || 'MANQUANT'}\n`;
                diagnostic += `   ‚Ä¢ checkeasy_url_params: ${localStorage.getItem('checkeasy_url_params') ? 'PR√âSENT' : 'MANQUANT'}\n\n`;
                
                // V√©rification IndexedDB (simul√©)
                diagnostic += 'üóÑÔ∏è ANALYSE INDEXEDDB:\n';
                diagnostic += `   ‚Ä¢ Base de donn√©es: ACCESSIBLE\n`;
                diagnostic += `   ‚Ä¢ Session active: ${localStorage.getItem('activeCheckId') ? 'PROBABLE' : 'AUCUNE'}\n\n`;
                
                // Recommandations
                diagnostic += 'üí° RECOMMANDATIONS:\n';
                if (!urlParams.get('parcours') && !urlParams.get('checkid')) {
                    diagnostic += '   ‚Ä¢ Aucun param√®tre URL - V√©rifier la restauration\n';
                }
                if (urlParams.get('checkid') !== localStorage.getItem('activeCheckId')) {
                    diagnostic += '   ‚Ä¢ Synchroniser checkId URL ‚Üî localStorage\n';
                }
                diagnostic += '   ‚Ä¢ Surveillance continue recommand√©e\n';
                
                resultsContainer.textContent = diagnostic;
                addLog('Diagnostic complet termin√©');
                
            } catch (error) {
                resultsContainer.textContent = `‚ùå Erreur diagnostic:\n${error.message}`;
                addLog(`Erreur diagnostic: ${error.message}`, 'error');
            }
        }
        
        // Tentative de r√©paration automatique
        async function attemptAutoFix() {
            const resultsContainer = document.getElementById('diagnosticResults');
            resultsContainer.style.display = 'block';
            
            let fixes = 'üîß R√âPARATION AUTOMATIQUE\n';
            fixes += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const urlCheckId = urlParams.get('checkid');
                const localCheckId = localStorage.getItem('activeCheckId');
                
                let fixesApplied = 0;
                
                // Fix 1: Synchroniser checkId
                if (urlCheckId && localCheckId && urlCheckId !== localCheckId) {
                    localStorage.setItem('activeCheckId', urlCheckId);
                    fixes += '‚úÖ Synchronisation checkId URL ‚Üí localStorage\n';
                    fixesApplied++;
                }
                
                // Fix 2: Sauvegarder chemin actuel
                const currentPath = window.location.pathname;
                localStorage.setItem('checkeasy_last_path', currentPath);
                fixes += '‚úÖ Sauvegarde chemin actuel\n';
                fixesApplied++;
                
                // Fix 3: Sauvegarder param√®tres URL
                if (urlParams.toString()) {
                    const paramsToSave = {
                        parcours: urlParams.get('parcours'),
                        checkid: urlParams.get('checkid'),
                        path: currentPath,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('checkeasy_url_params', JSON.stringify(paramsToSave));
                    fixes += '‚úÖ Sauvegarde param√®tres URL\n';
                    fixesApplied++;
                }
                
                fixes += `\nüìä R√âSUM√â: ${fixesApplied} corrections appliqu√©es\n`;
                
                if (fixesApplied > 0) {
                    fixes += '\nüîÑ Actualisation de l\'√©tat recommand√©e\n';
                    setTimeout(refreshCurrentState, 1000);
                }
                
                resultsContainer.textContent = fixes;
                addLog(`R√©paration auto: ${fixesApplied} corrections appliqu√©es`);
                
            } catch (error) {
                fixes += `‚ùå Erreur r√©paration: ${error.message}\n`;
                resultsContainer.textContent = fixes;
                addLog(`Erreur r√©paration: ${error.message}`, 'error');
            }
        }
        
        // Reset complet
        async function resetAllData() {
            if (!confirm('‚ö†Ô∏è ATTENTION: Cette action va supprimer toutes les donn√©es de navigation sauvegard√©es. Continuer ?')) {
                return;
            }
            
            try {
                // Nettoyer localStorage
                localStorage.removeItem('activeCheckId');
                localStorage.removeItem('checkeasy_last_path');
                localStorage.removeItem('checkeasy_url_params');
                
                // Nettoyer URL
                const url = new URL(window.location);
                url.searchParams.delete('parcours');
                url.searchParams.delete('checkid');
                window.history.replaceState({}, '', url);
                
                addLog('Reset complet effectu√© - Toutes les donn√©es supprim√©es', 'warning');
                refreshCurrentState();
                
            } catch (error) {
                addLog(`Erreur reset: ${error.message}`, 'error');
            }
        }
        
        // Gestion des logs
        function startLogging() {
            if (isLogging) return;
            
            isLogging = true;
            addLog('üü¢ Surveillance d√©marr√©e');
            
            // Surveiller les changements d'URL
            let lastUrl = window.location.href;
            logInterval = setInterval(() => {
                const currentUrl = window.location.href;
                if (currentUrl !== lastUrl) {
                    addLog(`üîÑ Navigation d√©tect√©e: ${currentUrl}`);
                    lastUrl = currentUrl;
                }
            }, 1000);
            
            // Surveiller localStorage
            const originalSetItem = localStorage.setItem;
            localStorage.setItem = function(key, value) {
                if (key.includes('checkeasy') || key === 'activeCheckId') {
                    addLog(`üíæ localStorage modifi√©: ${key} = ${value.substring(0, 50)}${value.length > 50 ? '...' : ''}`);
                }
                originalSetItem.apply(this, arguments);
            };
        }
        
        function stopLogging() {
            if (!isLogging) return;
            
            isLogging = false;
            if (logInterval) {
                clearInterval(logInterval);
                logInterval = null;
            }
            addLog('üî¥ Surveillance arr√™t√©e');
        }
        
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '<div class="log-entry"><span class="log-timestamp">[--:--:--]</span><span>Logs effac√©s</span></div>';
        }
        
        // Fonctions utilitaires
        function clearTestResults() {
            document.getElementById('testResults').style.display = 'none';
            addLog('R√©sultats de tests effac√©s');
        }
        
        function exportState() {
            const state = {
                url: window.location.href,
                localStorage: {
                    activeCheckId: localStorage.getItem('activeCheckId'),
                    lastPath: localStorage.getItem('checkeasy_last_path'),
                    urlParams: localStorage.getItem('checkeasy_url_params')
                },
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `navigation-state-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            addLog('√âtat export√© vers fichier JSON');
        }
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            refreshCurrentState();
            addLog('üöÄ Diagnostic de navigation initialis√©');
        });
    </script>
</body>
</html>
