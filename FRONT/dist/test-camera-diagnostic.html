<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé• Diagnostic Cam√©ra - CheckEasy</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    h1 {
      margin-bottom: 20px;
      color: #333;
      text-align: center;
      font-size: 2em;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 1.1em;
    }
    .status {
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 12px;
      background: #e3f2fd;
      border-left: 6px solid #2196f3;
      font-size: 1.1em;
    }
    .error {
      background: #ffebee;
      border-left-color: #f44336;
    }
    .success {
      background: #e8f5e9;
      border-left-color: #4caf50;
    }
    video {
      width: 100%;
      max-width: 640px;
      border-radius: 12px;
      margin: 20px auto;
      background: #000;
      display: block;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .button-group {
      text-align: center;
      margin: 25px 0;
    }
    button {
      padding: 15px 30px;
      margin: 8px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(45deg, #2196f3, #21cbf3);
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .btn-rear {
      background: linear-gradient(45deg, #4caf50, #8bc34a);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }
    .btn-front {
      background: linear-gradient(45deg, #ff9800, #ffc107);
      box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
    }
    .btn-stop {
      background: linear-gradient(45deg, #f44336, #e91e63);
      box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
    }
    .log {
      background: #1a1a1a;
      color: #00ff41;
      padding: 20px;
      border-radius: 12px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 500px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      margin-top: 20px;
      border: 2px solid #333;
    }
    .cameras-list {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      border: 2px solid #e9ecef;
    }
    .camera-item {
      padding: 15px;
      background: white;
      margin: 10px 0;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      transition: all 0.3s ease;
    }
    .camera-item.active {
      border-color: #4caf50;
      background: #e8f5e9;
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
    }
    .camera-label {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .instructions {
      background: #fff3cd;
      border: 2px solid #ffeaa7;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }
    .instructions h3 {
      color: #856404;
      margin-bottom: 10px;
    }
    .instructions ol {
      color: #856404;
      margin-left: 20px;
    }
    .instructions li {
      margin: 8px 0;
    }
    .copy-btn {
      background: linear-gradient(45deg, #9c27b0, #e91e63);
      box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé• Diagnostic Cam√©ra</h1>
    <p class="subtitle">Test des cam√©ras iPhone/Android pour CheckEasy</p>
    
    <div class="instructions">
      <h3>üìã Instructions :</h3>
      <ol>
        <li><strong>Cliquez</strong> sur "üì∑ Tester Cam√©ra ARRI√àRE"</li>
        <li><strong>Autorisez</strong> l'acc√®s √† la cam√©ra dans la popup</li>
        <li><strong>V√©rifiez</strong> si la vid√©o s'affiche</li>
        <li><strong>Cliquez</strong> sur "üìã Copier les logs" et envoyez-les moi</li>
      </ol>
    </div>
    
    <div id="deviceInfo" class="status"></div>
    
    <div class="button-group">
      <button class="btn-rear" onclick="testCamera('environment')">üì∑ Tester Cam√©ra ARRI√àRE</button>
      <button class="btn-front" onclick="testCamera('user')">ü§≥ Tester Cam√©ra AVANT</button>
      <button class="btn-stop" onclick="stopCamera()">‚èπÔ∏è Arr√™ter</button>
      <button class="copy-btn" onclick="copyLogs()">üìã Copier les logs</button>
    </div>
    
    <video id="video" autoplay playsinline muted></video>
    
    <div id="camerasList" class="cameras-list" style="display:none;"></div>
    
    <div id="log" class="log">üöÄ Pr√™t pour le diagnostic...\n</div>
  </div>

  <script>
    let currentStream = null;
    let availableCameras = [];
    let allLogs = [];
    
    // Fonction de log avec couleurs
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : 'üìù';
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? '#ff4444' : type === 'success' ? '#44ff44' : type === 'warning' ? '#ffaa44' : '#00ff41';
      
      const logEntry = `[${timestamp}] ${emoji} ${message}`;
      allLogs.push(logEntry);
      
      logDiv.innerHTML += `<span style="color: #888">[${timestamp}]</span> <span style="color: ${color}">${emoji} ${message}</span>\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(logEntry);
    }
    
    // Copier les logs dans le presse-papiers
    function copyLogs() {
      const logsText = allLogs.join('\n');
      navigator.clipboard.writeText(logsText).then(() => {
        alert('üìã Logs copi√©s dans le presse-papiers !\n\nVous pouvez maintenant les coller et me les envoyer.');
      }).catch(() => {
        // Fallback pour les navigateurs qui ne supportent pas clipboard API
        const textarea = document.createElement('textarea');
        textarea.value = logsText;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert('üìã Logs copi√©s ! (m√©thode fallback)\n\nVous pouvez maintenant les coller et me les envoyer.');
      });
    }
    
    // D√©tecter l'appareil avec plus de d√©tails
    function detectDevice() {
      const ua = navigator.userAgent;
      const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
      const isAndroid = /Android/.test(ua);
      const isSafari = /Safari/.test(ua) && !/Chrome/.test(ua);
      const isChrome = /Chrome/.test(ua);
      const isFirefox = /Firefox/.test(ua);
      
      let browser = 'Inconnu';
      if (isIOS) browser = 'Safari iOS';
      else if (isAndroid && isChrome) browser = 'Chrome Android';
      else if (isAndroid) browser = 'Android Browser';
      else if (isChrome) browser = 'Chrome Desktop';
      else if (isFirefox) browser = 'Firefox';
      else if (isSafari) browser = 'Safari Desktop';
      
      const info = {
        platform: navigator.platform,
        userAgent: ua,
        isIOS,
        isAndroid,
        isSafari,
        isChrome,
        browser
      };
      
      document.getElementById('deviceInfo').innerHTML = `
        <strong>üîç Appareil d√©tect√©:</strong> ${info.browser}<br>
        <strong>üñ•Ô∏è Plateforme:</strong> ${info.platform}<br>
        <strong>üì± User Agent:</strong> ${ua.substring(0, 100)}...
      `;
      
      log(`üîç Device: ${info.browser} / ${info.platform}`);
      log(`üì± iOS: ${isIOS}, Android: ${isAndroid}, Safari: ${isSafari}`);
      return info;
    }
    
    // √ânum√©rer les cam√©ras avec d√©tection intelligente
    async function enumerateCameras() {
      try {
        log('üîç === √âNUM√âRATION DES CAM√âRAS ===', 'info');
        
        // D'abord demander la permission g√©n√©rale
        log('üì± Demande permission cam√©ra g√©n√©rale...');
        const tempStream = await navigator.mediaDevices.getUserMedia({ video: true });
        log('‚úÖ Permission cam√©ra accord√©e !', 'success');
        
        // Arr√™ter le stream temporaire
        tempStream.getTracks().forEach(track => track.stop());
        await new Promise(resolve => setTimeout(resolve, 500)); // D√©lai plus long
        
        // Maintenant √©num√©rer les devices
        log('üì± √ânum√©ration des devices...');
        const devices = await navigator.mediaDevices.enumerateDevices();
        availableCameras = devices.filter(d => d.kind === 'videoinput');
        
        log(`‚úÖ ${availableCameras.length} cam√©ra(s) d√©tect√©e(s) !`, 'success');
        
        // Afficher la liste des cam√©ras
        const camerasList = document.getElementById('camerasList');
        camerasList.style.display = 'block';
        camerasList.innerHTML = '<h3>üìπ Cam√©ras disponibles :</h3>';
        
        availableCameras.forEach((cam, index) => {
          const label = cam.label || `Cam√©ra ${index + 1}`;
          const id = cam.deviceId.substring(0, 15);
          
          // D√©tection intelligente du type de cam√©ra
          const labelLower = label.toLowerCase();
          let facing = '‚ùì Type inconnu';
          let facingClass = '';
          
          if (labelLower.includes('front') || labelLower.includes('face') || labelLower.includes('user') || labelLower.includes('selfie')) {
            facing = 'ü§≥ CAM√âRA AVANT';
            facingClass = 'front';
          } else if (labelLower.includes('back') || labelLower.includes('rear') || labelLower.includes('environment') || labelLower.includes('main')) {
            facing = 'üì∑ CAM√âRA ARRI√àRE';
            facingClass = 'rear';
          }
          
          camerasList.innerHTML += `
            <div class="camera-item ${facingClass}" id="cam-${index}">
              <div class="camera-label">${facing}</div>
              <strong>üìù Nom:</strong> ${label}<br>
              <strong>üÜî ID:</strong> ${id}...
            </div>
          `;
          
          log(`  ${facing} - "${label}" (${id}...)`);
        });
        
        return availableCameras;
      } catch (err) {
        log(`‚ùå ERREUR √©num√©ration: ${err.name} - ${err.message}`, 'error');
        log(`‚ùå Stack: ${err.stack}`, 'error');
        throw err;
      }
    }
    
    // Tester une cam√©ra avec toutes les strat√©gies
    async function testCamera(facingMode) {
      log(`\nüé¨ ========== TEST CAM√âRA ${facingMode.toUpperCase()} ==========`, 'info');
      
      stopCamera();
      
      const video = document.getElementById('video');
      const deviceInfo = detectDevice();
      
      try {
        // √ânum√©rer les cam√©ras si pas encore fait
        if (availableCameras.length === 0) {
          await enumerateCameras();
        }
        
        let stream = null;
        let successStrategy = null;
        
        // === STRAT√âGIE 1: facingMode avec ideal (recommand√© WebRTC) ===
        if (!stream) {
          log(`üì± STRAT√âGIE 1: facingMode ideal "${facingMode}"`, 'info');
          try {
            stream = await navigator.mediaDevices.getUserMedia({
              audio: false,
              video: {
                facingMode: { ideal: facingMode },
                width: { ideal: deviceInfo.isIOS ? 1280 : 1920 },
                height: { ideal: deviceInfo.isIOS ? 720 : 1080 }
              }
            });
            successStrategy = 'Strat√©gie 1 (ideal facingMode)';
            log('‚úÖ STRAT√âGIE 1 R√âUSSIE !', 'success');
          } catch (err) {
            log(`‚ö†Ô∏è Strat√©gie 1 √©chou√©e: ${err.name} - ${err.message}`, 'warning');
          }
        }
        
        // === STRAT√âGIE 2: facingMode direct ===
        if (!stream) {
          log(`üì± STRAT√âGIE 2: facingMode direct "${facingMode}"`, 'info');
          try {
            stream = await navigator.mediaDevices.getUserMedia({
              audio: false,
              video: {
                facingMode: facingMode,
                width: { ideal: deviceInfo.isIOS ? 1280 : 1920 }
              }
            });
            successStrategy = 'Strat√©gie 2 (direct facingMode)';
            log('‚úÖ STRAT√âGIE 2 R√âUSSIE !', 'success');
          } catch (err) {
            log(`‚ö†Ô∏è Strat√©gie 2 √©chou√©e: ${err.name} - ${err.message}`, 'warning');
          }
        }
        
        // === STRAT√âGIE 3: deviceId exact ===
        if (!stream && availableCameras.length > 0) {
          log(`üì± STRAT√âGIE 3: deviceId exact`, 'info');
          const wantFront = facingMode === 'user';
          
          const targetCamera = availableCameras.find(cam => {
            const label = cam.label.toLowerCase();
            if (wantFront) {
              return label.includes('front') || label.includes('face') || label.includes('user') || label.includes('selfie');
            } else {
              return label.includes('back') || label.includes('rear') || label.includes('environment') || label.includes('main');
            }
          });
          
          if (targetCamera) {
            log(`  üéØ Ciblage cam√©ra: "${targetCamera.label}"`);
            try {
              stream = await navigator.mediaDevices.getUserMedia({
                audio: false,
                video: { deviceId: { exact: targetCamera.deviceId } }
              });
              successStrategy = 'Strat√©gie 3 (deviceId exact)';
              log('‚úÖ STRAT√âGIE 3 R√âUSSIE !', 'success');
            } catch (err) {
              log(`‚ö†Ô∏è Strat√©gie 3 √©chou√©e: ${err.name} - ${err.message}`, 'warning');
            }
          } else {
            log(`‚ö†Ô∏è Aucune cam√©ra trouv√©e pour "${facingMode}"`, 'warning');
          }
        }
        
        // === STRAT√âGIE 4: facingMode basique ===
        if (!stream) {
          log(`üì± STRAT√âGIE 4: facingMode basique`, 'info');
          try {
            stream = await navigator.mediaDevices.getUserMedia({
              audio: false,
              video: { facingMode: facingMode }
            });
            successStrategy = 'Strat√©gie 4 (facingMode basique)';
            log('‚úÖ STRAT√âGIE 4 R√âUSSIE !', 'success');
          } catch (err) {
            log(`‚ö†Ô∏è Strat√©gie 4 √©chou√©e: ${err.name} - ${err.message}`, 'warning');
          }
        }
        
        // === STRAT√âGIE 5: deviceId ideal (fallback) ===
        if (!stream && availableCameras.length > 0) {
          log(`üì± STRAT√âGIE 5: deviceId ideal (fallback)`, 'info');
          const wantFront = facingMode === 'user';
          
          const targetCamera = availableCameras.find(cam => {
            const label = cam.label.toLowerCase();
            if (wantFront) {
              return label.includes('front') || label.includes('face') || label.includes('user');
            } else {
              return label.includes('back') || label.includes('rear') || label.includes('environment');
            }
          });
          
          if (targetCamera) {
            try {
              stream = await navigator.mediaDevices.getUserMedia({
                audio: false,
                video: { deviceId: { ideal: targetCamera.deviceId } }
              });
              successStrategy = 'Strat√©gie 5 (deviceId ideal)';
              log('‚úÖ STRAT√âGIE 5 R√âUSSIE !', 'success');
            } catch (err) {
              log(`‚ö†Ô∏è Strat√©gie 5 √©chou√©e: ${err.name} - ${err.message}`, 'warning');
            }
          }
        }
        
        // V√©rifier si on a un stream
        if (!stream) {
          throw new Error('‚ùå TOUTES LES STRAT√âGIES ONT √âCHOU√â !');
        }
        
        // === SUCC√àS: Configurer la vid√©o ===
        log(`\nüéâ === SUCC√àS avec ${successStrategy} ===`, 'success');
        
        currentStream = stream;
        video.srcObject = stream;
        
        // Lecture de la vid√©o
        try {
          await video.play();
          log('‚úÖ Vid√©o en lecture !', 'success');
        } catch (playErr) {
          log(`‚ö†Ô∏è Erreur video.play(): ${playErr.message}`, 'warning');
          // Essayer de forcer la lecture apr√®s un d√©lai
          setTimeout(() => {
            video.play().catch(e => log(`‚ö†Ô∏è Deuxi√®me tentative play() √©chou√©e: ${e.message}`, 'warning'));
          }, 200);
        }
        
        // === INFORMATIONS DU STREAM ===
        const track = stream.getVideoTracks()[0];
        const settings = track.getSettings();
        const capabilities = track.getCapabilities ? track.getCapabilities() : {};
        
        log(`\nüìπ === INFORMATIONS DU STREAM ===`, 'info');
        log(`üìù Label: ${track.label}`);
        log(`üìù FacingMode: ${settings.facingMode || 'N/A'}`);
        log(`üìù R√©solution: ${settings.width}x${settings.height}`);
        log(`üìù DeviceId: ${settings.deviceId?.substring(0, 15)}...`);
        log(`üìù FrameRate: ${settings.frameRate || 'N/A'}`);
        
        if (capabilities.facingMode) {
          log(`üìù Capabilities facingMode: ${JSON.stringify(capabilities.facingMode)}`);
        }
        
        // Mettre √† jour l'UI
        document.querySelectorAll('.camera-item').forEach(el => el.classList.remove('active'));
        const activeIndex = availableCameras.findIndex(cam => cam.deviceId === settings.deviceId);
        if (activeIndex >= 0) {
          document.getElementById(`cam-${activeIndex}`).classList.add('active');
          log(`‚úÖ Cam√©ra active: Index ${activeIndex}`, 'success');
        }
        
        log(`\nüéØ === TEST TERMIN√â AVEC SUCC√àS ===`, 'success');
        
      } catch (err) {
        log(`\nüí• === √âCHEC TOTAL ===`, 'error');
        log(`‚ùå Erreur: ${err.name} - ${err.message}`, 'error');
        log(`‚ùå Stack: ${err.stack}`, 'error');
        
        // Afficher une alerte utilisateur
        alert(`‚ùå Erreur cam√©ra: ${err.message}\n\nV√©rifiez les logs en bas pour plus de d√©tails.`);
      }
    }
    
    function stopCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => {
          track.stop();
          log(`‚èπÔ∏è Track arr√™t√©: ${track.label}`);
        });
        currentStream = null;
        document.getElementById('video').srcObject = null;
        log('‚èπÔ∏è Cam√©ra arr√™t√©e', 'info');
        
        // Retirer la classe active
        document.querySelectorAll('.camera-item').forEach(el => el.classList.remove('active'));
      }
    }
    
    // Initialisation au chargement
    window.addEventListener('DOMContentLoaded', () => {
      log('üöÄ Page de diagnostic charg√©e');
      const deviceInfo = detectDevice();
      log('üì± Cliquez sur "üì∑ Tester Cam√©ra ARRI√àRE" pour commencer');
      log('‚ö†Ô∏è IMPORTANT: Utilisez le bouton "üìã Copier les logs" pour me les envoyer !');
    });
    
    // Gestion des erreurs globales
    window.addEventListener('error', (e) => {
      log(`‚ùå Erreur JavaScript: ${e.message}`, 'error');
    });
    
    window.addEventListener('unhandledrejection', (e) => {
      log(`‚ùå Promise rejet√©e: ${e.reason}`, 'error');
    });
  </script>
</body>
</html>
